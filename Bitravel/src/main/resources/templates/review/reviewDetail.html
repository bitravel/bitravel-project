<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	layout:decorator="layout1"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
<!-- <link rel="stylesheet" th:href="@{/css/style.css}" /> 다른곳에 적용 중인지 확인을 위해 남겨둠-->
<title>여행 후기 게시판 :: BITravel</title>
</head>


<th:block layout:fragment="modal-board">
	<div id="commentModal" class="modal" tabindex="-1" role="dialog"
		aria-labelledby="commentModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-body">
					<form>
						<!-- <div class="form-group">
		                        <label for="modalWriter" class="col-form-label">작성자</label>
		                        <input type="text" id="modalWriter" class="form-control" placeholder="작성자를 입력해 주세요." />
		                    </div> -->
						<div class="form-group">
							<label for="modalContent" class="col-form-label">내용</label>
							<textarea id="modalContent" class="form-control"
								placeholder="내용을 입력해 주세요."></textarea>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="btnModalCancel"
						class="btn btn-default waves-effect waves-light"
						data-bs-dismiss="modal">취소하기</button>
					<button type="button" id="btnCommentUpdate"
						class="btn btn-primary waves-effect waves-light"
						onclick="updateComment()">수정하기</button>
					<button type="button" id="btnCommentDelete"
						class="btn btn-danger waves-effect waves-light">삭제하기</button>
				</div>
			</div>
		</div>
	</div>
</th:block>
<!--Main content start-->
<th:block layout:fragment="content">
	<main>
		<section id="article-header" class="position-relative bg-tint-primary">
			<div class="container pt-11 pt-lg-14 pb-7 pb-lg-12 position-relative">
				<article class="row pb-7">
					<div class="col-lg-10 col-xl-8">
						<div class="position-relative pb-3 pb-lg-0">
							<div class="d-flex align-items-center w-100">
								<small class="text-muted">작성일: </small> <small id="reviewDate"
									class="text-muted"></small>
							</div>

							<div>
								<h2 id="reviewTitle" class="my-3 display-3"></h2>
								<div class="d-flex mb-0 small align-items-center">
									<img src="/assets/img/avatar/6.jpg" alt=""
										class="size-40 rounded-circle me-2"> <span
										class="text-muted d-inline-block"><a id="nickname"
										href="#!" class="text-dark"></a></span>
								</div>
							</div>
						</div>

					</div>
				</article>
				<!--/.article-->
			</div>


			<!--Divider-->
			<svg class="position-absolute start-0 bottom-0 text-white"
				preserveAspectRatio="none" width="100%" height="120"
				viewBox="0 0 800 240" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M800 240H0L800 0V240Z" fill="currentColor" />
                </svg>

		</section>
		<!--/.Article header-end-->

		<section class="position-relative">
			<div class="container pb-7">
				<div
					class="swiper-container swiper-progress rounded-xl overflow-hidden shadow-lg mt-n15">
					<div class="swiper-wrapper">
						<div class="swiper-slide rounded-xl overflow-hidden">
							<img src="/assets/img/1200x600/1.jpg" alt=""
								class="img-fluid rounded-xl position-relative">
						</div>
						<div class="swiper-slide rounded-xl overflow-hidden">
							<img src="/assets/img/1200x600/4.jpg" alt=""
								class="img-fluid rounded-xl position-relative">
						</div>
						<div class="swiper-slide rounded-xl overflow-hidden">
							<img src="/assets/img/1200x600/3.jpg" alt=""
								class="img-fluid rounded-xl position-relative">
						</div>
					</div>
					<div
						class="swiper-pagination swiperProgress-pagination swiper-pagination-progressbar"></div>
					<!-- Add Arrows -->
					<div
						class="swiper-button-next swiperProgress-button-next bg-white size-60"></div>
					<div
						class="swiper-button-prev swiperProgress-button-prev bg-white size-60"></div>
				</div>
				<!-- 메인 Content -->
				<div class="row pt-7">
					<div class="col-xl-9 mx-auto">

						<div class="form-group box-content" name="form-line"
							th:each="list: ${rtList}">[[${list.travelName}]]</div>

						<div class="form-group">
							<div class="col-sm mb-5">
								<p id="reviewContent" style="word-break: break-word;"></p>
							</div>
						</div>
						<!--                         	<div class="article mb-8 box-content"> -->
						<!--                         		<div class="col-sm-10"><p id="reviewContent"></p></div> -->
						<!-- 					    	</div> -->
						<!--/.article-->
						<!-- 지도 -->
						<div class="container py-2 pb-0 mt-1" th:each="list: ${rtList}">
							<button class="mb-4 py-3 border-bottom border-4 border-secondary"
								th:attr="onclick=|initMap('${list.latitude}, ${list.longitude}, ${list.travelName}')|">지도
								보기</button>
							<button onclick="relayout()">재호출</button>
						</div>
						<div
							class="d-flex align-items-center justify-content-center mb-4 pt-2">
							<div id="map" style="width: 800px; height: 400px;"></div>
						</div>
						댓글
						<div class="box-content">
							<div class="card-content">
								<div class="clearfix">
									<h4 class="box-title pull-left">댓글</h4>
									<!-- /.box-title -->
								</div>
								<form class="form-horizontal form-view">
									<div class="input-group margin-bottom-20">
										<input type="text" id="content" class="form-control"
											onkeydown="javascript: if (event.keyCode == 13) {insertComment();}">
										<input type="text" style="width: 0px; visibility: hidden;">
										<div class="input-group-btn"
											style="vertical-align: top !important;">
											<button type="button" class="btn-primary btn-lg"
												style="font-size: medium;" onclick="insertComment()">
												등록</button>
										</div>
									</div>
									<table class="notice-list" style="width:100%; table-layout:fixed;"></table>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<div class="btn_wrap text-center" style="margin-bottom: 50px;">
			<a href="javascript: void(0);" onclick="goList();"
				class="btn btn-default waves-effect waves-light">뒤로가기</a> <a
				href="javascript: void(0);" onclick="goWrite();"
				class="btn btn-primary waves-effect waves-light">수정하기</a>
			<button type="button" onclick="deleteBoard();"
				class="btn btn-danger waves-effect waves-light">삭제하기</button>
		</div>

	</main>
</th:block>

<!-- scripts -->
<th:block layout:fragment="script">
	<script th:inline="javascript"
		src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script th:inline="javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=00a11497c3c6b583a0da2c02517cb49c"></script>

	<script th:inline="javascript">
	/*<![CDATA[*/
		var id;
		
    	window.onload = () => {
    		id = /*[[ ${id} ]]*/;
     		reviewList();
     		printCommentList();
    	}
    	
    	/**
		* 모달창 앞으로 이동
		**/

		$('#commentModal').appendTo("body")

        /**
         * 후기 상세 조회
         */

        function reviewList() {

            fetch(`/api/reviews/${id}`).then(response => {
            	if (!response.ok) {
        			throw new Error('Request failed...');
        	    }
            	return response.json();

           	}).then(json => {
           		console.table(json);
           		console.table(json.reviewDate);
            	json.reviewDate = moment(json.reviewDate).format('YYYY-MM-DD HH:mm:ss');
            	Object.keys(json).forEach(key => {
             		const elem = document.getElementById(key);
             		if (elem) {
              			elem.innerHTML = json[key];
             		}
             
            	});
            	
           	}).catch(error => {
            	alert('게시글 정보를 찾을 수 없습니다.');
            	//goList();
           	});
        }
        
        /**
         * 댓글 수정 창
         */
         function openModal(commentId, nickname, content) {

				$("#commentModal").modal("toggle");

				//document.getElementById("modalWriter").value = writer;
				document.getElementById("modalContent").value = content;

				document.getElementById("btnCommentUpdate").setAttribute("onclick", "updateComment("+ commentId +")");
				document.getElementById("btnCommentDelete").setAttribute("onclick", "deleteComment("+ commentId +")");
			}
			
         	/**
	         * 댓글 유효성 검사
	         */
	        function isValid() {
	        
	          	const form = document.getElementById('content');
	        
	        	if (!content.value.trim()) {
	        		alert('내용을 입력해 주세요.');
	        		content.value = '';
	        		content.focus();
	        		return false;
	        	}
	        
	        	return true;
	        }
         	
	        /**
			* 댓글 작성
			**/
			function insertComment() {
				
				if ( !isValid() ) {
					return false;
				}
				
				var content = document.getElementById("content");
				
				const id = /*[[ ${id} ]]*/;
				var uri = `/api/reviews/comments/${id}`;
				var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "POST"};
				var params = {"reviewId": [[ ${id} ]], "commentContent": content.value};
				console.log(params);
				$.ajax({
					url: uri,
					type: "POST",
					headers: headers,
					dataType: 'json',
					data: JSON.stringify(params),
					success: function(response) {						
						if (response.result == false) {
							alert("댓글 등록에 실패하였습니다.");
							return false;
							} 
						printCommentList();
						content.value = "";
						},
					error: function(xhr, status, error) {
						alert("에러가 발생하였습니다.");
						return false;
						}
					});
				}
			
			/**
			* 댓글 수정
			**/
			function updateComment(commentId) {
				
				const id = /*[[ ${id} ]]*/;
				var writer = document.getElementById("modalWriter");
				var content = document.getElementById("modalContent");
			
				var uri = `/api/reviews/comments/${commentId}`;
				var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "PATCH"};
				var params = {"commentId": commentId, "commentContent": content.value};
			
				$.ajax({
					url: uri,
					type: "PATCH",
					headers: headers,
					dataType: "json",
					data: JSON.stringify(params),
					success: function(response) {
						if (response.result == false) {
							alert("댓글 수정에 실패하였습니다.");
							return false;
						}
			
						printCommentList();
						$("#commentModal").modal("hide");
					},
					error: function(xhr, status, error) {
						alert("에러가 발생하였습니다.");
						return false;
					}
				});
			}
			
			/**
			* 댓글 삭제
			**/
			function deleteComment(commentId) {

				if (!confirm('댓글을 삭제하시겠어요?')) {
					return false;
				}
			
				var uri = [[ @{/api/reviews/comments/} ]] + commentId;
				var headers = {"Content-Type": "application/json", "X-HTTP-Method-Override": "DELETE"};
			
				$.ajax({
					url: uri,
					type: "DELETE",
					headers: headers,
					dataType: "json",
					success: function(response) {
						if (response.result == false) {
							alert("댓글 삭제에 실패하였습니다.");
							return false;
						}
			
						printCommentList();
						$("#commentModal").modal("hide");
					},
					error: function(xhr, status, error) {
						alert("에러가 발생하였습니다.");
						return false;
					}
				});
			}
			
			
			/**
			* 댓글 조회
			**/
			function printCommentList() {

				fetch('/api/reviews/comments/[[ ${id} ]]').then(response => {
					if (response.ok) {
						return response.json();
					}
				}).then(json => {
					console.table(json) //확인
					let html = '';

					if (!json.length) {
						html = '<td colspan="4">등록된 게시글이 없습니다.</td>';
					} else {
						json.forEach((obj) => {
							html += `
								<li>
									<span class="name">${obj.nickname}</span>
	    							<span class="desc">${obj.commentContent}</span>
	    							
	    							<button type="button" onclick="openModal(${obj.rcommentId}, '${obj.nickname}', '${obj.commentContent}' )" class="btn btn-xs btn-circle"><i class="glyphicon glyphicon-pencil" aria-hidden="true"></i></button>
								</li>
							`;
						});
					}
					$(".notice-list").html(html);
				});
			}
			/*[- end of function -]*/
		
        

        /**
         * 뒤로가기
         */
        function goList() {
        	const url = window.location.href;
			location.href = url.slice(0, url.indexOf(id)) + '' + window.location.search;
			/* location.href = "javascript:history.back(-1)";*/ 
        }

        /**
         * 수정하기
         */
        function goWrite() {
        	location.href = `/review/write?id=[[ ${id} ]]`;
        }

        /**
         * 삭제하기
         */
        function deleteBoard() {

        	const id = /*[[ ${id} ]]*/;

            if ( !confirm(`${id}번 게시글을 삭제할까요?`) ) {
            	return false;
            }

            fetch(`/api/reviews/${id}`, {
            	method: 'DELETE',
              	headers: { 'Content-Type': 'application/json' },

            }).then(response => {
            	if (!response.ok) {
               		throw new Error('삭제가 불가능합니다. 관리자에게 문의하세요.');
              	}

              	alert('삭제되었습니다.');
              	goList();

            }).catch(error => {
            	alert('오류가 발생하였습니다.');
            });
    	}
        
        /*지도 map*/
        function initMap(latitude, longitude, travelName) {
			var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
			var options = { //지도를 생성할 때 필요한 기본 옵션
							center: new kakao.maps.LatLng(latitude, longitude), //지도의 중심좌표.
							level: 3 //지도의 레벨(확대, 축소 정도)
						};	
			var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
			
			var markerPosition  = new kakao.maps.LatLng(latitude, longitude); 
		
			// 마커를 생성합니다
			var marker = new kakao.maps.Marker({
				position: markerPosition
			});
		
			// 마커가 지도 위에 표시되도록 설정합니다
			marker.setMap(map);
		
			// 커스텀 오버레이에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
			var content = '<div>' +
		    '    <span class="fw-bold bg-light form-control p-1 pb-0 pt-0 mb-2">'+ travelName +'</span><pre><br></pre>' +
		    '</div>';
		
			// 커스텀 오버레이가 표시될 위치입니다 
			var position = new kakao.maps.LatLng(latitude, longitude);  
		
			// 커스텀 오버레이를 생성합니다
			var customOverlay = new kakao.maps.CustomOverlay({
				map: map,
				position: position,
				content: content,
				yAnchor: 1 
			});
			function relayout() {    
	            map.relayout();
	        }
		}
        
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = { 
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };

    	// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
    	var map = new kakao.maps.Map(mapContainer, mapOption); 
        
        
       
    /*]]>*/
    </script>
</th:block>
</html>
